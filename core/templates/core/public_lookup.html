<!-- templates/core/public_lookup.html -->
{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Public Name Lookup</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h3 class="mb-3">Public Name Lookup</h3>

      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <input
            id="ctx"
            class="form-control"
            placeholder="Search for Context (e.g. Gaming, Legal)"
          />
        </div>
        <div class="col-md-4">
          <input
            id="al"
            class="form-control"
            placeholder="Search for Language"
          />
        </div>
        <div class="col-md-2">
          <select id="mode" class="form-select">
            <option value="best">Best match</option>
            <option value="list">List all matches</option>
          </select>
        </div>
        <div class="col-md-2 d-grid">
          <button id="go" class="btn btn-primary">Apply</button>
        </div>
      </div>

      <div id="box" class="card p-3">Loading…</div>
      <a href="/api/home/" class="btn btn-outline-secondary mt-3">Back</a>
    </div>

    <script>
      (async function init() {
        const parts = window.location.pathname.split("/");
        // /api/public/lookup-page/<username>/
        const username = decodeURIComponent(parts[parts.length - 2]);

        const box = document.getElementById("box");
        const ctxInput = document.getElementById("ctx");
        const alInput = document.getElementById("al");
        const modeSel = document.getElementById("mode");
        const goBtn = document.getElementById("go");

        function pad2(n) {
          return String(n).padStart(2, "0");
        }
        function formatDateISO(s) {
          if (!s) return "-";
          const d = new Date(s);
          if (isNaN(d)) return s;
          return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(
            d.getDate()
          )} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }
        function titleCase(s) {
          return (s || "")
            .toString()
            .replace(
              /\w\S*/g,
              (t) => t[0].toUpperCase() + t.slice(1).toLowerCase()
            );
        }
        function identityCard(idObj) {
          return `
        <div class="card h-100 shadow-sm mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <span class="fw-semibold">${titleCase(idObj.context || "")}</span>
              <span class="small text-muted">By: ${username}</span>
            </div>
            <div class="view-mode">
              <div class="mb-1"><strong>Name:</strong> ${
                idObj.display_name || "-"
              }</div>
              <div class="mb-1"><strong>Language:</strong> ${
                idObj.language || "-"
              }</div>
              <div class="mb-2 text-muted small">
                Last updated: ${formatDateISO(idObj.updated_at)}
                <span class="ms-2">•</span> Created: ${formatDateISO(
                  idObj.created_at
                )}
              </div>
            </div>
          </div>
        </div>`;
        }

        // Prefill from URL (if opened with ?context=...&accept_language=...&mode=...)
        const qs = new URLSearchParams(location.search);
        if (ctxInput) ctxInput.value = qs.get("context") || "";
        if (alInput) alInput.value = qs.get("accept_language") || "";
        if (modeSel)
          modeSel.value =
            (qs.get("mode") || "best") === "all"
              ? "list"
              : qs.get("mode") || "best";

        async function load() {
          const ctx = (ctxInput?.value || "").trim();
          const lang = (alInput?.value || "").trim();
          const mode = (modeSel?.value || "best").trim(); // "best" or "list"

          const params = new URLSearchParams();
          if (ctx) params.set("context", ctx);
          if (lang) params.set("accept_language", lang);
          params.set("mode", mode);

          const res = await fetch(
            `/api/public/lookup/${encodeURIComponent(username)}/?` +
              params.toString()
          ).catch(() => null);
          if (!res || !res.ok) {
            box.textContent = "Failed to load.";
            return;
          }
          const data = await res.json();

          const header = `
        <div><strong>User:</strong> ${data.username}</div>
        <div><strong>Context used:</strong> ${data.applied_context || "-"}</div>
        <div><strong>Language preference:</strong> ${
          (data.accept_language || []).join(", ") || "-"
        }</div>
        <hr/>`;

          const items = data.results || [];
          if (mode === "list") {
            box.innerHTML =
              header +
              (items.length
                ? items.map(identityCard).join("")
                : "<div>No matches.</div>");
          } else {
            const first = items[0] || null;
            box.innerHTML =
              header +
              (first ? identityCard(first) : "<div>No identity found.</div>");
          }
        }

        goBtn.addEventListener("click", load);
        await load(); // initial render
      })();
    </script>
  </body>
</html>
